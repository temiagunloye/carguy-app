rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // CARS COLLECTION
    // Users can read/write their own cars
    match /cars/{carId} {
      allow read, write: if request.auth != null && 
                            request.resource.data.userId == request.auth.uid;
    }
    
    // USERS COLLECTION
    // Users can read/write their own user document
    // Tier is set to 'free' on signup, can be upgraded via admin/billing (future)
    match /users/{userId} {
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      // Allow create with tier='free' only
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.tier == 'free' &&
                       request.resource.data.extraVehicleSlots == 0;
      // Allow update of non-tier fields only (tier changes via admin/cloud functions)
      allow update: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.tier == resource.data.tier &&
                       request.resource.data.extraVehicleSlots == resource.data.extraVehicleSlots;
    }
    
    // RENDER JOBS COLLECTION
    // Users can read render jobs for their own cars
    match /renderJobs/{jobId} {
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      // Only Cloud Functions can write to render jobs
      allow write: if false;
    }
    
    // BASE MODELS COLLECTION
    // All authenticated users can read base models
    match /baseModels/{baseModelId} {
      allow read: if request.auth != null;
      // Only admins/functions can write
      allow write: if false;
    }
    
    // VEHICLES COLLECTION (Pro/Premium only)
    // Users can read/write their own vehicles
    match /vehicles/{vehicleId} {
      allow read: if request.auth != null && 
                     resource.data.ownerUid == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.ownerUid == request.auth.uid;
      allow update, delete: if request.auth != null && 
                               resource.data.ownerUid == request.auth.uid;
    }
    
    // BUILDS COLLECTION
    // Users can read/write their own builds
    match /builds/{buildId} {
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
                               resource.data.userId == request.auth.uid;
    }
    
    // STANDARD CARS COLLECTION (Dealer Library)
    // All authenticated users can read, only admins can write
    match /standardCars/{standardCarId} {
      allow read: if request.auth != null;
      // Only admins (custom claim) can write
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // STANDARD CAR VARIANTS COLLECTION
    // All authenticated users can read, only admins can write
    match /standardCarVariants/{variantId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // STYLE PROFILES COLLECTION
    // All authenticated users can read, only admins can write
    match /styleProfiles/{styleProfileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // PARTS CATALOG COLLECTION
    // All authenticated users can read, only admins can write
    match /partsCatalog/{partId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // USER BUILDS SUBCOLLECTION (Free Tier Enforcement)
    // Users can only access their own builds
    match /users/{userId}/builds/{buildId} {
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      // Allow create/update with savedPartsCount validation
      allow create, update: if request.auth != null && 
                               request.auth.uid == userId &&
                               request.resource.data.savedPartsCount <= 3;
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }
  }
}