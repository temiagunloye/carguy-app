rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // CARS COLLECTION
    // Users can read/write their own cars
    match /cars/{carId} {
      allow read, write: if request.auth != null && 
                            request.resource.data.userId == request.auth.uid;
    }
    
    // USERS COLLECTION
    // Users can read/write their own user document
    // Tier is set to 'free' on signup, can be upgraded via admin/billing (future)
    match /users/{userId} {
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      // Allow create with tier='free' only
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.tier == 'free' &&
                       request.resource.data.extraVehicleSlots == 0;
      // Allow update of non-tier fields only (tier changes via admin/cloud functions)
      allow update: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.tier == resource.data.tier &&
                       request.resource.data.extraVehicleSlots == resource.data.extraVehicleSlots;
    }
    
    // RENDER JOBS COLLECTION
    // Users can read render jobs for their own cars
    match /renderJobs/{jobId} {
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      // Only Cloud Functions can write to render jobs
      allow write: if false;
    }
    
    // BASE MODELS COLLECTION
    // Public read for 3D viewer, no writes (admin only via Console)
    match /baseModels/{baseModelId} {
      allow read: if true; // Public read for 3D viewer
      allow write: if false; // Only admins via Firebase Console
    }
    
    // VEHICLES COLLECTION (Pro/Premium only)
    // Users can read/write their own vehicles
    match /vehicles/{vehicleId} {
      allow read: if request.auth != null && 
                     resource.data.ownerUid == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.ownerUid == request.auth.uid;
      allow update, delete: if request.auth != null && 
                               resource.data.ownerUid == request.auth.uid;
    }
    
    // BUILDS COLLECTION
    // Users can read/write their own builds
    match /builds/{buildId} {
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && 
                               resource.data.userId == request.auth.uid;
    }
    
    // STANDARD CARS COLLECTION (Dealer Library)
    // All authenticated users can read, only admins can write
    match /standardCars/{standardCarId} {
      allow read: if request.auth != null;
      // Only admins (custom claim) can write
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // STANDARD CAR VARIANTS COLLECTION
    // All authenticated users can read, only admins can write
    match /standardCarVariants/{variantId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // STYLE PROFILES COLLECTION
    // All authenticated users can read, only admins can write
    match /styleProfiles/{styleProfileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // PARTS CATALOG COLLECTION
    // All authenticated users can read, only admins can write
    match /partsCatalog/{partId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.admin == true;
    }
    
    // USER BUILDS SUBCOLLECTION (Free Tier Enforcement)
    // Users can only access their own builds
    match /users/{userId}/builds/{buildId} {
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      // Allow create/update with savedPartsCount validation
      allow create, update: if request.auth != null && 
                               request.auth.uid == userId &&
                               request.resource.data.savedPartsCount <= 3;
      allow delete: if request.auth != null && 
                       request.auth.uid == userId;
    }
    
    // ========================================
    // BODY SHOP / DEALER NETWORK COLLECTIONS
    // ========================================
    
    // DEALERS COLLECTION
    // Public read for dealer directory, only dealer admins can write their own
    match /dealers/{dealerId} {
      allow read: if true; // Public directory
      allow create: if request.auth != null && 
                       request.auth.token.bodyshopAdmin == true;
      allow update: if request.auth != null && 
                       (request.auth.token.bodyshopAdmin == true ||
                        resource.data.adminUid == request.auth.uid);
      allow delete: if request.auth != null && 
                       request.auth.token.bodyshopAdmin == true;
    }
    
    // PARTS COLLECTION
    // Public read for parts inventory, only dealer admins can write their own parts
    match /parts/{partId} {
      allow read: if true; // Public parts catalog
      allow create: if request.auth != null && 
                       get(/databases/$(database)/documents/dealers/$(request.resource.data.dealerId)).data.adminUid == request.auth.uid;
      allow update, delete: if request.auth != null && 
                               get(/databases/$(database)/documents/dealers/$(resource.data.dealerId)).data.adminUid == request.auth.uid;
    }
    
    // JOBS COLLECTION
    // Only shop admins can read/write their own jobs
    match /jobs/{jobId} {
      allow read: if request.auth != null && 
                     (resource.data.shopId == request.auth.uid ||
                      get(/databases/$(database)/documents/dealers/$(resource.data.shopId)).data.adminUid == request.auth.uid);
      allow create: if request.auth != null && 
                       get(/databases/$(database)/documents/dealers/$(request.resource.data.shopId)).data.adminUid == request.auth.uid;
      allow update, delete: if request.auth != null && 
                               get(/databases/$(database)/documents/dealers/$(resource.data.shopId)).data.adminUid == request.auth.uid;
    }
    
    // PORTAL TOKENS COLLECTION
    // No direct client access - server-side only via API
    match /portalTokens/{tokenId} {
      allow read, write: if false; // Server-side only
    }
    
    // PORTAL APPROVALS COLLECTION
    // No direct client access - server-side only via API
    match /portalApprovals/{approvalId} {
      allow read: if request.auth != null && 
                     get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.shopId == request.auth.uid;
      allow write: if false; // Server-side only via portal API
    }
    
    // BODYSHOP LEADS COLLECTION
    // Write-only from client, read-only for admins
    match /bodyshopLeads/{leadId} {
      allow read: if request.auth != null && 
                     request.auth.token.bodyshopAdmin == true;
      allow create: if true; // Public lead submission
      allow update: if request.auth != null && 
                       request.auth.token.bodyshopAdmin == true;
      allow delete: if false; // Never delete leads
    }

    // ========================================
    // ANALYTICS COLLECTIONS (Server-side Only)
    // ========================================

    // PAGE VIEWS
    // No direct client access. Written via /api/page-views (Admin SDK)
    match /pageViews/{viewId} {
      allow read, write: if false;
    }

    // EVENTS
    // No direct client access. Written via /api/track-event (Admin SDK)
    match /events/{eventId} {
      allow read, write: if false;
    }
  }
}