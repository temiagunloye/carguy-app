<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal | Garage Manager</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="../css/bodyshop.css">
    <style>
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.active {
            background: #22c55e;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }
    </style>
</head>

<body style="background: #0a0a0a; color: #f5f5f5;">
    <!-- Header -->
    <header
        style="border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(10,10,10,0.9); backdrop-filter: blur(10px);">
        <div style="max-width: 900px; margin: 0 auto; padding: 1.5rem;">
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: 700; color: #3b82f6; margin-bottom: 0.25rem;">GARAGE MANAGER
                </div>
                <div id="shop-name" style="font-size: 0.875rem; color: #a3a3a3;">Build Preview Portal</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div style="max-width: 900px; margin: 0 auto; padding: 2rem 1.5rem;">
        <!-- Loading State -->
        <div id="loading-state" style="text-align: center; padding: 4rem;">
            <div style="font-size: 1.125rem; color: #a3a3a3;">Loading your build preview...</div>
        </div>

        <!-- Error State -->
        <div id="error-state" style="display: none; text-align: center; padding: 4rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">Invalid or Expired Link</div>
            <div style="font-size: 0.875rem; color: #a3a3a3; margin-bottom: 1.5rem;">
                This preview link is no longer valid. Please contact your shop for a new link.
            </div>
        </div>

        <!-- Portal Content -->
        <div id="portal-content" style="display: none;">
            <!-- Vehicle Info -->
            <div
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                <div style="font-size: 0.75rem; color: #a3a3a3; margin-bottom: 0.5rem;">CURRENT BUILD</div>
                <div id="vehicle-name" style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">2022 BMW M3
                </div>
                <div id="vehicle-details" style="font-size: 0.875rem; color: #a3a3a3;">Brooklyn Grey ‚Ä¢ AWD ‚Ä¢ 12,430
                    miles</div>
            </div>

            <!-- Live Visualizer Section -->
            <div style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem;">Live Visualizer</h2>

                <!-- 3D Viewer Placeholder -->
                <div
                    style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 2rem; text-align: center; margin-bottom: 1.5rem;">
                    <div
                        style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border-radius: 0.75rem;">
                        <div style="color: #3b82f6; font-size: 0.875rem;">3D Viewer Integration Point</div>
                    </div>
                </div>

                <!-- Active Parts Toggles -->
                <div id="parts-toggles" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Parts will be loaded here -->
                </div>
            </div>

            <!-- Parts List -->
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">Planned Parts</h3>
                <div id="parts-list" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Parts will be loaded here -->
                </div>
            </div>

            <!-- Total -->
            <div
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 1.5rem; margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 1.125rem; font-weight: 600;">Total Estimate</div>
                    <div id="total-price" style="font-size: 1.5rem; font-weight: 700; color: #3b82f6;">$0</div>
                </div>
            </div>

            <!-- Approval Section -->
            <div
                style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; padding: 1.5rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">Your Feedback</h3>

                <textarea id="client-notes" placeholder="Any questions or changes you'd like to make?"
                    style="width: 100%; min-height: 100px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem; padding: 1rem; color: #f5f5f5; font-size: 0.875rem; resize: vertical; margin-bottom: 1rem;"></textarea>

                <div style="display: flex; gap: 0.75rem;">
                    <button id="approve-btn"
                        style="flex: 1; padding: 0.875rem; border-radius: 0.75rem; background: #22c55e; color: white; font-size: 0.875rem; font-weight: 600; border: none; cursor: pointer;">
                        ‚úì Approve Build
                    </button>
                    <button id="request-changes-btn"
                        style="flex: 1; padding: 0.875rem; border-radius: 0.75rem; background: rgba(255,255,255,0.1); color: #f5f5f5; font-size: 0.875rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); cursor: pointer;">
                        Request Changes
                    </button>
                </div>

                <div id="approval-message"
                    style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 0.75rem; text-align: center;">
                </div>
            </div>

            <!-- Shop Contact -->
            <div
                style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.875rem; color: #a3a3a3; margin-bottom: 0.5rem;">Questions about your build?
                </div>
                <div id="shop-contact" style="font-size: 0.875rem; color: #3b82f6;">Contact your shop</div>
            </div>
        </div>
    </div>

    <script type="module">
        // Demo job data
        const DEMO_JOB = {
            id: 'demo-job',
            vehicle: {
                make: 'BMW',
                model: 'M3',
                year: 2022,
                color: 'Brooklyn Grey',
                trim: 'AWD',
                mileage: '12,430 miles'
            },
            parts: [
                { id: 'p1', name: 'Wheels', detail: 'Forged 19"', status: 'in_stock', price: 1299, active: true },
                { id: 'p2', name: 'Front Lip', detail: 'Carbon', status: 'in_stock', price: 399, active: true },
                { id: 'p3', name: 'Lowering', detail: 'Springs', status: 'ordered', price: 249, active: true },
            ],
            shopName: 'Northside Auto Group',
            shopContact: 'contact@northsideauto.com'
        };

        let currentJob = null;
        let activePartsMap = {};

        function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                showError();
                return;
            }

            // For demo, show demo job
            if (token === 'demo') {
                loadJob(DEMO_JOB);
            } else {
                // TODO: Validate token and load job from Firestore
                setTimeout(() => {
                    showError();
                }, 1000);
            }
        }

        function loadJob(job) {
            currentJob = job;

            // Initialize active parts map
            job.parts.forEach(p => {
                activePartsMap[p.id] = p.active !== false;
            });

            // Update UI
            document.getElementById('shop-name').textContent = job.shopName;
            document.getElementById('vehicle-name').textContent = `${job.vehicle.year} ${job.vehicle.make} ${job.vehicle.model}`;
            document.getElementById('vehicle-details').textContent = `${job.vehicle.color} ‚Ä¢ ${job.vehicle.trim} ‚Ä¢ ${job.vehicle.mileage}`;
            document.getElementById('shop-contact').textContent = job.shopContact;

            renderPartsToggles();
            renderPartsList();
            updateTotal();

            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('portal-content').style.display = 'block';
        }

        function renderPartsToggles() {
            const container = document.getElementById('parts-toggles');
            container.innerHTML = currentJob.parts.map(p => `
                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem;">
                    <div style="width: 40px; height: 40px; background: rgba(59,130,246,0.1); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                        ${p.name === 'Wheels' ? '‚öôÔ∏è' : p.name === 'Front Lip' ? 'üèéÔ∏è' : 'üîß'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 0.875rem; font-weight: 600;">${p.name}</div>
                        <div style="font-size: 0.75rem; color: #a3a3a3;">${p.detail}</div>
                    </div>
                    <div class="toggle-switch ${activePartsMap[p.id] ? 'active' : ''}" data-part-id="${p.id}"></div>
                </div>
            `).join('');

            // Add toggle handlers
            container.querySelectorAll('.toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const partId = toggle.dataset.partId;
                    activePartsMap[partId] = !activePartsMap[partId];
                    toggle.classList.toggle('active');
                });
            });
        }

        function renderPartsList() {
            const container = document.getElementById('parts-list');
            container.innerHTML = currentJob.parts.map(p => {
                const statusColors = {
                    'in_stock': '#22c55e',
                    'ordered': '#eab308',
                    'planned': '#a3a3a3'
                };
                const statusLabels = {
                    'in_stock': 'In Stock',
                    'ordered': 'Ordered',
                    'planned': 'Planned'
                };
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 0.75rem;">
                        <div>
                            <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">${p.name} ‚Äî ${p.detail}</div>
                            <div style="font-size: 0.75rem; color: ${statusColors[p.status]};">‚óè ${statusLabels[p.status]}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.875rem; font-weight: 600;">$${p.price}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTotal() {
            const total = currentJob.parts.reduce((sum, p) => sum + p.price, 0);
            document.getElementById('total-price').textContent = `$${total.toLocaleString()}`;
        }

        function showError() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
        }

        // Approval handlers
        document.getElementById('approve-btn').addEventListener('click', async () => {
            await submitApproval(true);
        });

        document.getElementById('request-changes-btn').addEventListener('click', async () => {
            await submitApproval(false);
        });

        async function submitApproval(approved) {
            const notes = document.getElementById('client-notes').value;
            const messageEl = document.getElementById('approval-message');

            // TODO: Submit to API
            console.log('Approval:', { approved, notes });

            messageEl.textContent = approved
                ? '‚úì Build approved! Your shop will be in touch soon.'
                : '‚úì Feedback sent! Your shop will review your changes.';
            messageEl.style.display = 'block';
            messageEl.style.background = 'rgba(34, 197, 94, 0.1)';
            messageEl.style.border = '1px solid rgba(34, 197, 94, 0.3)';
            messageEl.style.color = '#22c55e';

            // Disable buttons
            document.getElementById('approve-btn').disabled = true;
            document.getElementById('request-changes-btn').disabled = true;
        }

        init();
    </script>
</body>

</html>